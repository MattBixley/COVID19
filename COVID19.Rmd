---
title: "**COVID19 - New Zealand**"
author: "**Matt Bixley**"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
    vertical_layout: fill
    theme: bootstrap
    #logo: images/coronavirus.png
---

<style>                     
.navbar {
  background-color:silver;
  border-color:black;
}
.navbar-brand {
color:black!important;
font-size: 20px;
}
</style>  

```{r setup, include=FALSE}
#------------------ Packages ------------------
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(scales)

#------------------ Parameters ------------------
# cases today
nzcases = 76
nzdeaths = 0 

options("scipen"=100, "digits"=6)

# plot themes
mytheme <- theme_classic() + 
  theme(legend.position="bottom") +
  theme(axis.line = element_line(colour = "grey50")) + # plot axis to grey
  theme(panel.grid.major = element_line(colour = "grey40", size = 0.4)) + # grid to grey
  theme(panel.grid.minor = element_line(colour = "grey70", size = 0.3)) + # grid to grey
  theme(panel.grid.major.x = element_blank()) + #remove the vertical grid lines 
  theme(panel.grid.minor.x = element_blank()) #remove the vertical grid lines


#------------------ Data ------------------
#source("code/import_jhu.R")
#source("code/population.R")

# read and tidy the ecdc data
source("code/import_ecdc.R")

# function to add the latest NZ data
source("code/insert_today.R")

# don't run the insert code if it morning, ie ecdc updated overnight
ifelse(format(Sys.time(), "%H:%M") < "13:00", 
       covid19,
       covid19 <- insert_today(nzcases = nzcases, nzdeaths = nzdeaths))

nz <- covid19 %>% filter(country == "New_Zealand")

```

Sidebar {.sidebar}
=====================================  

__**The Lockdown Diaries**__

Updates likely 9am NZDT with the over night European data. Just after 1pm NZDT with the New Zealand daily news and sometime in the evening.  

![](images/2019_nCoV.png){ width=100% }

**Sunday March 29th** (d4)  
Home Loop which means Flagstaff with Ann. Stunning day out. Not sure how many times I've done this loop over the years. It's a lot though and when training is my test piece to see how fit I am. 13k with 600m climb, pb around 69 minutes but who knows, I'm older and senile now.   

![Flagstaff](images/homeloop.jpg){ width=100% }


Moved into the extension, tidied up some plots and over plotted NZ for clarity. Still not happy with how they look, will insert some blow ups to see NZ a bit better. Short story, the curve is flattening.  

**Saturday March 28th** (d3)  
Strength, Run, Walk and moved gear into the new walkin wardrobe  
Bullied to share this link.

**Friday March 27th** (d2)  
Got this dashboard underway  
3x1min Boats, 2x1min Russian Twists  
2x1min Supermans each pair  

**Thursday March 26th** (d1)  
Home D - loving it  
PE instituted for the kids (Not Happy)  
3x20 Pushups  
3x10 Squat Jumps  
30 minute run  

**Wednesday March 25th** (d-1)  
Mitre10 for Paint rollers and bits and pieces  
NZDataScience Zoom Morning Tea  
Builders cleaned the windows  
Sparky rigged up the Hotwater Cylinder in the extension (good bastard)  
3x1min Boats  
2x1min Russian Twists  
3x10 Forward Lunges  
30 minute run  

**Tuesday March 24th** (d-2)  
Set up the home office, nipped down to work for a chair  
5x1min Planks  
3x10 Reverse Lunges  
30 minute run  


**Summary**
=======================================================================

Row {data-width=400}
-----------------------------------------------------------------------

### confirmed {.value-box}

```{r}
#valueBox(value, subtitle, icon = NULL, color = "aqua", width = 4,href = NULL)
valueBox(
  value = paste0(max(nz$cum_cases)," / ",max(nz$cum_deaths)),
  caption = "Cases / Deaths",
  icon = "fas fa-user-md",
  color = "silver"
)
```


### active {.value-box}

```{r}
valueBox(
  value = max(nz$per_million),
  caption = "Cases per million",
  icon = "fas fa-user-md",
  color = "silver"
)
```

### update {.value-box}

```{r}
valueBox(
  value = paste0(format(Sys.time(), "%B %d"),", ",format(Sys.time(), "%H:%M")),
  caption = "Updated",
  icon = "fas fa-clock",
  color = "silver"
)
```


Column {data-width=400}
-------------------------------------

### **Notes**  
Modifying the typical plot of cumulative cases per country, either log or raw scale, to adjust for population. Why?  

When comparisons first began, Hubei province and subsequently South Korea, Italy, Spain, Germany and France all have populations of approximtaley 60 Million people and arguably similar standards of living and health care. New Zealand though is an order of magnitude lower and the US nearly an order higher. In simple terms, New Zealand has far less hospital capacity and the US far higher as an absolute value. So absolute values are not interesting, adjusting for population size is. 

edit: there is a discrepency with MOH data because or some reason they have decided to report probable cases when no one else does. For consistency the data reverts to that reported by the ECDC.  

*I still need to tidy the plot.*  
  
### **Daily Per Capita Cases**  

```{r}

# plot nz growth
#who <- "New Zealand"
who <- c("New_Zealand", "Australia", "USA", "Italy", "China", "South_Korea", "Spain", "France", "Germany", "United_Kingdom")

fiveper <-  covid19 %>% filter(country %in% who, per_million > 5) %>%
  group_by(country) %>% 
  mutate(days5 = dense_rank(date))
fivenz <- fiveper %>% filter(country == "New_Zealand")


p1 <- fiveper %>% 
  ggplot(aes(x = days5, y = per_million, colour = country)) +
  geom_point() +
  geom_line() +
  labs(title = "Per Capita Cumulative Cases",
  subtitle = "days since 5 cases per million",
  x = "Days", y = "Cases\n(per Million People)") +
  scale_y_continuous(breaks = seq(0, 10000, 500)) +

  # overplot NZ
  geom_point(data = fivenz, aes(x = days5, y = per_million, colour = country), size = 3) +
  geom_line(data = fivenz, aes(x = days5, y = per_million, colour = country))


p1 + mytheme + labs(caption = "Matt Bixley") + 
  scale_colour_brewer(palette = "Paired")
  


```

**Plots**
=======================================================================


Column {data-width=400}
-------------------------------------


### **Cumulative Cases**
    
```{r}

#----------------------------------------
# Plotting the data
who <- c("New_Zealand", "Australia", "USA", "Italy", "China", "South_Korea", "Spain", "France", "Germany", "United_Kingdom")

dayssince <- covid19 %>% filter(country %in% who , cum_cases > 0) %>%
  group_by(country) %>% 
  mutate(days = dense_rank(date))

daysnz <- dayssince %>% filter(country == "New_Zealand")

p2 <- dayssince %>% 
  ggplot(aes(x = days, y = cum_cases, colour = country)) +
  geom_point() +
  geom_line() +
  geom_point(data = daysnz, aes(x = days, y = cum_cases, colour = country), size = 3) +
  geom_line(data = daysnz, aes(x = days, y = cum_cases, colour = country)) +
  #scale_x_continuous(trans = "log10") +
  scale_y_continuous(trans = "log10", labels = sprintf("%.0f", c(0, 10, 100, 1000,10000,100000,1000000)),
                     breaks = c(0, 10, 100, 1000,10000,100000,1000000),
                     minor_breaks = c(seq(0, 10, 2.5),
                                      seq(0, 100, 25),
                                      seq(100, 1000, 250),
                                      seq(1000, 10000, 2500),
                                      seq(10000, 100000, 25000))) +
  labs(title = "Cumulative Cases", subtitle = "Days since 1st case",
        x = "Days", y = "Cumulative Cases\n(log10") +
  theme(axis.text.y = element_text(size = 4))

p2 + mytheme + labs(caption = "Matt Bixley") + 
  scale_colour_brewer(palette = "Paired")


```
 
### **Daily Cases** plot needs work  

```{r}
who <- c("New_Zealand", "Australia", "USA", "Italy", "China", "South_Korea", "Spain", "France", "Germany", "United_Kingdom")

#who <- covid19 %>% filter(cum_cases > 400) %>% 
#  select(country) %>% 
#  distinct()

#p3 <- covid19 %>% filter(country %in% who$country) %>%
p3 <- covid19 %>% filter(country %in% who) %>%
  #mutate(daily_million = ifelse(daily_million == 0, NA, daily_million)) %>% 
  ggplot(aes(x = date, y = country, fill = cases_million)) + 
  geom_tile(colour = "white") + 
  scale_fill_gradient(low = "white", high = "orangered4", 
                      name = "Per Million") +
  ggtitle("Per Capita Case Incidence") +
  xlab("Days") + ylab("Cases/Million")
 

p3 + mytheme + labs(caption = "Matt Bixley") +  scale_colour_brewer(palette = "Oranges") +
  theme(panel.grid.major.y = element_blank()) + 
  theme(panel.grid.minor.x = element_blank())


```


**Map**
=======================================================================

### **World map of cases**


Map Coming Soon
```{r}
# make a map
#library(leaflet)
#library(leafpop)

#map_object %>%
#  addLayersControl(
#    overlayGroups = names(cv_data_for_plot.split),
#    options = layersControlOptions(collapsed = FALSE)
#  )
```


**Epidemiology**
=======================================================================

I have a shiny app to deploy here soon


**About**
=======================================================================

**The Coronavirus Dashboard: the case of New Zealand**

This Coronavirus dashboard provides an overview of the 2019/20 Novel Coronavirus COVID-19 (2019-nCoV) epidemic for New Zealand. This dashboard is built with R using the R Makrdown framework with Flexadashboard. Think of it as a living thing, it will change, like the change of going into a minimum of a month long lockdown. The data will not match that presented each day at 1pm (at the moment), there are differences in how data is reported by various sources, perhaps in time I will switch to the [Ministry of Health](https://www.health.govt.nz/our-work/diseases-and-conditions/covid-19-novel-coronavirus) for the New Zealand Data.

note: I have waited longer to share, but Greig Hamilton is impatient. Some of his work that I helped on can be found [here](http://www.rogaine-results.com/) not that he'd ever give me credit for it.

**Code**

The code behind this dashboard is available on [GitHub](https://github.com/mattbixley/covid19){target="_blank"}.

The original layout and first use of data came from [Rami Krispin](https://github.com/RamiKrispin/coronavirus_dashboard){target="_blank"} who created both a dashboard and a package with the Johns Hopkins Data [![](images/coronavirus.png){ width=3%}](https://github.com/RamiKrispin/coronavirus){target="_blank"}


**Data**

The input data for this dashboard is the dataset available from the
[![](images/logo-ecdc.png){ width=3%}](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide){target="_blank"} European Centre for Disease Prevention and Control

The data and dashboard are refreshed on a daily basis.

Some data is also pulled from the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) Coronavirus [repository](https://github.com/CSSEGISandData/COVID-19){target="_blank"}.
But I find that is late to update due to time zone differences.

**Contact**

For any question or feedback, you can email me <mattbixley72@gmail.com> or report an issue at the [GitHub repo](https://github.com/MattBixley/COVID19/issues){target="_blank"}

**Update**

The data is as of `r format(max(covid19$date), "%A %B %d, %Y")` and the dashboard has been updated on `r format(Sys.time(), "%A %B %d, %Y")` at `r format(Sys.time(), "%H:%M")`.

